name: Compilación Manual de Unity (con Docker)

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    name: Compilar para Windows 64-bit
    runs-on: ubuntu-latest
    
    permissions:
      packages: read
      
    steps:
      # 1. Clonar tu repositorio
      - name: Checkout
        uses: actions/checkout@v4 

      # 2. Cargar la caché de la Librería
      - name: Cache Library
        uses: actions/cache@v4 
        with:
          path: Library
          key: Library-2022.3.62f3-${{ hashFiles('Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-2022.3.62f3-

      # 3. Compilar usando la imagen de Docker
      - name: Build Project (Windows)
        env:
          UNITY_LICENSE_CONTENT: ${{ secrets.UNITY_LICENSE }}
        run: |
          docker run \
            -v $GITHUB_WORKSPACE:/project \
            -w /project \
            ghcr.io/game-ci/editor:ubuntu-2022.3.62f3-base-1 \
            /bin/bash -c "
              mkdir -p build/Windows &&
              /opt/unity/Editor/Unity \
                -batchmode \
                -quit \
                -projectPath . \
                -logFile build.log \
                -buildTarget StandaloneWindows64 \
                -customBuildPath build/Windows/MiJuego.exe
            "

      # 4. Mostrar el log si falla
      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4 
        with:
          name: build-log
          path: build.log

      # 5. Subir el .exe como un Artefacto
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4 
        with:
          name: build-Windows
          path: build/Windows/
